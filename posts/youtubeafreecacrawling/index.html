<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>유튜브 라이브, 아프리카TV 실시간 채팅 크롤링 하기 feat.배돌이의 당구생활 | 채수현 개발일지</title><meta name=keywords content="python,websockets,bs4,selenium,crawling"><meta name=description content="Python으로 BS4, selenium, websockets 크롤링으로 실시간 시청자들과 소통하기"><meta name=author content="cha2hyun"><link rel=canonical href=https://cha2hyun.github.io/posts/youtubeafreecacrawling/><link crossorigin=anonymous href=/assets/css/stylesheet.e2c4e45c227cff2d0b236143ff7f2e39b6a7f2bd2019a845c0f754cd1b58fa1f.css integrity="sha256-4sTkXCJ8/y0LI2FD/38uOban8r0gGahFwPdUzRtY+h8=" rel="preload stylesheet" as=style><link rel=icon href=https://cha2hyun.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://cha2hyun.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://cha2hyun.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://cha2hyun.github.io/apple-touch-icon.png><link rel=mask-icon href=https://cha2hyun.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="유튜브 라이브, 아프리카TV 실시간 채팅 크롤링 하기 feat.배돌이의 당구생활"><meta property="og:description" content="Python으로 BS4, selenium, websockets 크롤링으로 실시간 시청자들과 소통하기"><meta property="og:type" content="article"><meta property="og:url" content="https://cha2hyun.github.io/posts/youtubeafreecacrawling/"><meta property="og:image" content="https://cha2hyun.github.io/papermod-cover.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-03-23T00:00:00+00:00"><meta property="article:modified_time" content="2023-03-23T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://cha2hyun.github.io/papermod-cover.png"><meta name=twitter:title content="유튜브 라이브, 아프리카TV 실시간 채팅 크롤링 하기 feat.배돌이의 당구생활"><meta name=twitter:description content="Python으로 BS4, selenium, websockets 크롤링으로 실시간 시청자들과 소통하기"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://cha2hyun.github.io/posts/"},{"@type":"ListItem","position":2,"name":"유튜브 라이브, 아프리카TV 실시간 채팅 크롤링 하기 feat.배돌이의 당구생활","item":"https://cha2hyun.github.io/posts/youtubeafreecacrawling/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"유튜브 라이브, 아프리카TV 실시간 채팅 크롤링 하기 feat.배돌이의 당구생활","name":"유튜브 라이브, 아프리카TV 실시간 채팅 크롤링 하기 feat.배돌이의 당구생활","description":"Python으로 BS4, selenium, websockets 크롤링으로 실시간 시청자들과 소통하기","keywords":["python","websockets","bs4","selenium","crawling"],"articleBody":"들어가며 김치빌리아드, 큐찾사 유튜브채널 배돌이의 당구생활의 컨텐츠 라이브 개인큐 추첨에서 실시간 시청자들의 댓글을 긁어와서 추첨하는게 필요했습니다. (다시봐도 매주 백만원 넘게 뿌리는 진짜 미친 이벤트이긴 합니다.)\n배당생 개인큐 추첨 라이브 진짜 100% 진짜..\n이벤트는 매우 매우 간단한 방법으로 채팅에 참여한 사람들을 추출해서 돌림판에 넣고 추첨합니다. 초반에는 유튜브에서 제공하는 채팅방 실시간 참여자를 드래그해서 추첨판에 복붙하였습니다. 저의 부캐 채PD로 제가 직접 방송에 참여하면서 컴퓨터를 조작하면 괜찮지만 방송에 참여하지 못하는 날들엔 배돌이가 직접 하기에 어려운 부분이 있어서 클릭 한 번만 하면 자동으로 해주는 실행파일 프로그램을 만들기로 했습니다.\n유튜브 라이브 실시간 댓글 크롤링 결과 미리보기\n구상한 순서는 다음과 같습니다.\n배돌이가 채팅 참여해주세요 라고 말하고 크롤링 프로그램을 킨다. 배돌이가 마감합니다 라고 말하고 아무 키를 누르면 크롤링이 끝난다 채팅에 참여한 모든 사람들을 추출한다. 셀레늄으로 돌림판 제공하는 사이트를 띄우고 추출한 사람들을 자동으로 넣고 돌린다. 라이브러리 유튜브 라이브의 경우 서드파티 라이브러리가 많이 있습니다. Don't reinvent the wheel이란 말처럼 (귀차니즘) 라이브러리를 사용하기로 했고 여기서 사용한 라이브러리는 pychat 입니다.\nThread 추첨을 시작하고 추첨을 끝내기 위해선 어떠한 이벤트가 발생해야 하는데 키보드의 아무 키가 입력되면 멈추게끔 프로그램을 작동시켜야합니다. 그러기 위해서는 멀티쓰레드로 키보드 이벤트를 감지하는 쓰레드가 하나 계속 돌고있어야 합니다.\n코드 youtube 크롤링 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 import pyperclip import pytchat import time import threading as th import os from selenium import webdriver from selenium.webdriver.common.by import By from selenium.webdriver.chrome.service import Service from webdriver_manager.chrome import ChromeDriverManager # 키보드 이벤트 감지 CAPTURING = True def stop_capture(): global CAPTURING input() CAPTURING = False def start_capture(video_id): # 키보드 이벤트 감지를 쓰레드로 실행 th.Thread(target=stop_capture, args=(), name='stop_capture', daemon=True).start() chat = pytchat.create(video_id=video_id) author_name = [] start = time.strftime('%Y-%m-%d %H-%M-%S', time.localtime(time.time())) today = time.strftime('%Y-%m-%d', time.localtime(time.time())) # 결과값을 저장할 위치 current = os.getcwd() path = f'{current}/{today}' try: if not os.path.exists(path): os.makedirs(path) except OSError: print(\"Error: Cannot create the directory {}\".format(path)) fp = open(f'{path}/{start}.txt', 'w') cnt = 0 # 크롤링 시작 while CAPTURING and chat.is_alive(): try: for c in chat.get().sync_items(): if c.author.name not in author_name: author_name.append(f'{c.author.name} | @{c.author.channelId}') print(f\"[{c.datetime[11:]}] 아이디: {c.author.name} | @{c.author.channelId}\\n\\t 내용: {c.message}\") fp.write(f\"[{c.datetime[11:]}] 아이디: {c.author.name} | @{c.author.channelId}\\n\\t 내용: {c.message}\\n\") cnt += 1 except KeyboardInterrupt: break chat.terminate() end = time.strftime('%Y-%m-%d %H:%M:%S', time.localtime(time.time())) author_name.sort() author_name = (list(set(author_name))) print('\\n====================================================================') print(f\"배돌이의당구생활 라이브 추첨 댓글 추출\\n시작 {start} | 종료 {end}\") print(f\"채팅에 참여한 사람 {len(list(set(author_name)))}명 (중복제거) | 총 채팅수 : {format(cnt, ',')}개\") print(author_name) print('====================================================================\\n\\n') print('추출을 종료합니다.') fp.write('\\n====================================================================\\n') fp.write(f\"배돌이의당구생활 라이브 추첨 댓글 추출\\n시작 {start} | 종료 {end}\\n\") fp.write(f\"채팅에 참여한 사람 {len(list(set(author_name)))}명 (중복제거) | 총 채팅수 : {cnt}개\\n\") fp.write(f\"{author_name}\\n\") fp.write('====================================================================\\n') fp.close() time.sleep(0.5) picker(author_name) return author_name def list_chuck(arr, n): return [arr[i: i + n] for i in range(0, len(arr), n)] def picker(author_name): try: driver = webdriver.Chrome(service=Service(ChromeDriverManager().install())) url = 'https://spinnerwheel.ahaslides.com/?entries=\u0026action=true' driver.get(url) driver.implicitly_wait(3) input_box = driver.find_element(By.XPATH, '//*[@id=\"aha-spinner-wheel\"]/div[2]/div/div[3]/div[2]/form/div/div/input') add_button = driver.find_element(By.XPATH, '//*[@id=\"aha-spinner-wheel\"]/div[2]/div/div[3]/div[2]/form/button') result = list_chuck(author_name, 30) for r in result: text = ','.join(r) JS_ADD_TEXT_TO_INPUT = \"\"\" var elm = arguments[0], txt = arguments[1]; elm.value += txt; elm.dispatchEvent(new Event('change')); \"\"\" driver.execute_script(JS_ADD_TEXT_TO_INPUT, input_box, text) time.sleep(1) input_box.send_keys(' ') add_button.click() while(1): pass except: pass print('\\n========================================') print(f\"배돌이의당구생활 라이브 추첨 댓글 추출\") video_id = input(\"영상 URL을 입력해주세요 : \") print(f\"확인되었습니다. 댓글 추출을 시작합니다.\") print('========================================') author_name = start_capture(video_id) 코드설명 pychat 라이브러리를 사용하기 떄문에 코드가 매우 간단합니다. start_capture로 캡쳐가 시작되고 함께 th.Thread(target=stop_capture, args=(), name='stop_capture', daemon=True).start()로 stop_capture 함수를 쓰레드로 시작합니다.\nstop_capture에서 input()을 기다리고 있는데 이는 실행중에 키보드값이 입력되면 global로 선언된 CAPTURING 변수를 false로 변경하여 크롤링을 멈추게 됩니다. 쓰레드를 활용하는 환경에서 전체적으로 참조해야할 변수를 선언하려면 꼭 global을 사용해야합니다.\n키보드 이벤트가 감지되어 추출이 멈추게되면 picker 함수를 실행시킵니다. 해당 함수는 selenium을 이용하여 결과값을 돌림판에 입력하는것 까지 자동으로 진행되게 합니다. 닉네임 중복이 가능하므로 유저의 고유번호까지 추출되어야하며 나중에 비교하기 위해서 텍스트 파일로 결과를 저장합니다. 추출 결과값을 브라우저의 인풋에 넣고 확인을 눌러줘야 하는데 이때 어쩔 수 없이 자바스크립트 문법이 필요하였습니다. 실행파일 실행파일로 만들고 어떠한 환경에서도 실행되어야 해서 기존의 웹드라이버를 수동으로 다운받아서 옮기지 않고 자동으로 다운로드 받아야하여 다음 명령어로 웹드라이버를 로드하였습니다. webdriver.Chrome(service=Service(ChromeDriverManager().install()))\n실행파일로 만들어주기 위해 pyinstaller 라이브러리를 사용했습니다. 이렇게 하면 최신 드라이버를 받아주고 실행파일 용량압박에도 살아남을 수 있게됩니다.\n이미지도 깜찍하게\n결과 실제로 어떻게 작동되는지 궁금하시면 다음 링크나 아래 영상을 확인해주세요. 도움이 되셨다면 구독과.. 좋..아…요…\n아프리카TV 실시간 댓글 크롤링 방송프로그램으로 OBS를 사용하고 있는데, 최근 M1맥 업데이트로 동시송출 플러그인 사용이 가능해졌습니다. 유트브에서 유튜브 + 아프리카TV로 넘어가는 계획중인데 추첨방송을 계속 이어서 진행하기 위해 유튜브, 아프리카tv 두개 채팅을 실시간으로 크롤링하려 합니다.\n아프리카TV의 경우 참고할만한 레퍼런스가 매우 매우 매우 매우 매우 없어서 정말… 맨땅에 해딩했는데 성공했다는 뿌듯함에 상세히 과정을 함께 보여드리려 합니다. (아직 현재진행중)\n아프리카TV 채팅방 분석 (23년 3월 23일 기준) 탭이동 하면 소켓연결이 끊어지고 다시 돌아오면 새로 연결된다\n크롬의 개발자도구 네트워크탭을 분석해보면 아프리카TV의 채팅방의 경우 대략적으로 다음과 같이 웹소켓 서버와 연결됨을 알 수 있습니다.\n사람이 동영상을 보고있는지 계속 확인하는 웹소켓 1개 일정시간마다 핸드쉐이크를 꼐속 진행한다\n사람이 동영상을 보고있다고 판단되면 채팅방 연결하는 웹소켓 1개 맨 처음에만 핸드쉐이크\n사람이 동영상을 안보고있다고 판단되면 모든 소켓 연결을 끊어버립니다. 소리는 들려도 채팅은 보여지지 않습니다. 다시 동영상에 입장하면 당연히 처음부터 소켓연결을 재시작하기 떄문에 이전 채팅 내용들이 사라지게 됩니다 입장, 퇴장 여부도 전부 소켓에 찍힙니다.\n우선 가장 중요한 부분은 실제 채팅이 오고 가는 것이 찍히는 위 2번 웹소켓입니다. 해당 웹소켓에 연결하기 위해서는 ⭐️다음 값들을⭐️ 알아야합니다.\n웹소켓 주소 채팅방 입장시 받아오는 API 혹은 1번 웹소켓에서 불러와질 수 있습니다.\n핸드쉐이크때 필요한 값 위의 웹소켓 주소를 받아올때 같이 넘겨받는 값이 특정 bytes array 구조로 보내져야합니다.\n우선은 1번 2번은 재껴두고 소켓에 연결해서 채팅을 넘겨받을 수 있는지 확인해보겠습니다.\n채팅을 어떻게든 불러올 수 있을까? (핸드쉐이크 분석) 총 2번의 핸드쉐이크 혹은 정보를 전달하는 것을 알 수 있습니다. 각각의 핸드쉐이크때 어떠한 정보를 보내야 연결이 성공되어 나머지 정보도 전달받는지 분석이 필요합니다. 첫번째 핸드쉐이크 첫번째 핸드쉐이크의 값중 유의미한 값은 A32.로 시작합니다. 네트워크탭을 분석해본 결과 아프리카TV API로 요청을 보낼때 쿠키로 함께 보내지는 PdboxTicket 값임을 확인했습니다. 추가로 많은 테스트 결과 해당값은 절대 변하지 않는 값으로 한번만 확인하면 계속 사용할 수 있는 값입니다.\n두번째 핸드쉐이크 두번째 핸드쉐이크는 _ 로 나누어지거나 \u0026으로 값이 나누어 져있었습니다. \u0026으로 나누어진 것을 보면 뭔가 파라미터 값을 전송하는 것으로 예측 할 수 있습니다. 전달되는 값들은 API의 리스폰스나 JS파일을 분석하면 나옵니다. 우선은 파이썬으로 핸드쉐이크떄 보내지는 값을 그대로 전송했을때 연결이 되는지 확인해봅니다 Test Code 해당값을 UTF-8즉 string 형태로 그대로 복사할 경우 깨져서 보여지지 않기 떄문에 base64 값으로 복사한다음에 코드에서 복호화 하는 형태로 진행합니다.\n핸드쉐이크 테스트 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 import certifi import ssl import base64 import asyncio import websockets # WSS 연결 위한 SSL 설정 ssl_context = ssl.create_default_context() ssl_context.load_verify_locations(certifi.where()) ssl_context.check_hostname = False ssl_context.verify_mode = ssl.CERT_NONE # 아래 3개 변수값은 어딘가의 API로 부터 받은 값들의 조합으로 우선은 그대로 사용 Base64PdboxTicket = 'GwkwMDAxMDAwNTg3MDAMLkEzMi43YmJUNTZ2eUhNOWZLWmsuQ1V0N0dxNXdzSW95ZGdUejRvT0JkUGJEVTRPTEJjbDNEUkFUenJUYkhrQzlYRmtiZnl1YXMwUzE3SFlyZDFjbFU1VzV4U3hpTUJYS2lmV25fVXFDQThWWUYxczVidE04QzJuenhWN3NEVzlTcHFPM2V4VHNHQUMxU3ZmNTlCNUE1bDVrUFJsZHpleHB4OGxKbkJFYXE5UXNLbW1KQ21TTExQRm1JNkc3Q0FHZ1R0UDFWcGhzaTYzTDZXUHRDdkRPalZDNTg1LXVJQV9hRGRxcTlWX1pOWUlBQ0N3d3Yxb0NDckRLeE9icldKS0xpQlNrbGs3bW1TMkkwWVdtNnhiMDB2TG53OGJuQXVyZzRyNkpHeWVma0ZDWmZaM0V6c29LTEFwRU9xeFlkX0JXMVNxRWVNM1FuNkoyc0E5Y0d5WGFZLWhySm5wblJGNmN4RzFPTWJBSi1KVGVXc2JTLTNaNUNULS1fUW1vTWJCb2stSmJwUmt1Y1oxMURJSkFpY25NZmwxaWtzU1Y4aHh6YUVqWVExb19pamI1OXVCWUNYMlNsMFdLSEwydjk4WkhSLXZGNjNRRDY5VEtqSEpjaHBIaDh0RFNzUUxJekc3WUFZbmpKYjl3cDlvV2JfVi0wSFgyRFRYVnVUSEtKRTFPMWNtbHE1bC1qaXZ6bW1HdnJ0WnVmQVVfRG1NQzA1bUpPelNxZTl0bzNKVFZmMjBJWldfWXFpW...==' Base64ChannelInfo = 'GwkwMDAyMDAwMjk3MDAMOTYxOAw0NTY1MzFjMDg0YjUxMGJkOTAyYWViZDcyMjFiMjUyNl92bGZ2bGY3ODlfMjQ1NTkwMzY1X2lvcwwwDAxsb2cRBiYGc2V0X2JwcwY9BjgwMDAGJgZ2aWV3X2JwcwY9BjEwMDAGJgZxdWFsaXR5Bj0Gbm9ybWFsBiYGdXVpZAY9BjFlNDNjZjZkMzc5MTNjMzZiMzVkNTgwZTBiNTY1NmVjBiYGZ2VvX2NjBj0GS1IGJgZnZW9fcmMGPQYxMQYmBmFjcHRfbGFuZwY9BmtvX0tSBiYGc3ZjX2xhbmcGPQZrb19LUgYmBmpvaW5fY2MGPQY0MTAScHdkERJhdXRoX2luZm8RTlVMTBJwdmVyETESYWNjZXNzX3N5c3R...=' WSSUrl = 'wss://chat-76dbfccf.afreecatv.com:8001/Websocket/vlfvlf789' async def connect(): # 웹 소켓에 접속을 합니다. async with websockets.connect(WSSUrl, subprotocols=['chat'], ssl=ssl_context, ping_interval=None) as websocket: # 핸드쉐이크 await websocket.send(base64.b64decode(Base64PdboxTicket)) await websocket.recv() await websocket.send(base64.b64decode(Base64ChannelInfo)) # 이후부터 채팅내용 받아와짐 while True: try: data = await websocket.recv() print(data) except Exception as e: print(\"ERROR:\", e) asyncio.get_event_loop().run_until_complete(connect()) 코드 실행시 데이터를 성공적으로 잘 받아오는 것을 확인 할 수 있었습니다.\n단, 바이트 코드로 되어있으면서 hex 값이랑 평문이랑 섞여있기 때문에 해당 데이터를 복호화 해줍니다. \\x0c 값이 계속 보이는 것으로 보아 해당 값으로 split 해주고 utf-8로 변환하였습니다.\n1 2 3 4 5 6 def decode(bytes): test = bytes.split(b'\\x0c') res = [] for i in test: res.append(str(i, 'utf-8')) print(res) 해당 코드로 복호화 하였을 경우에 유의미한 값이 보여지는 것을 확인했습니다. res[1] 값에 따라서 배열의 크기가 변경되는 것을 보아 해당 값을 기준으로 어떤 데이터인지 유추해볼 수 있습니다. 여러번 테스트해본 결과 다음과 같습니다.\nres[1] = 1 일때 res[2]=id res[3]=닉네임가 채팅방에 입장 하였음 res[1] = -1 일때 res[2]=id res[3]=닉네임가 채팅방에 퇴장 하였음 res[1] = '문자열' 일때 res[1]=닉네임 res[2]=id res[6]=채팅내용 보여지는 채팅입니다. 다른 경우에는 매니저 이거나 팬 일때 아이디가 색상으로 표시되는 경우 등이 있었지만 위 3가지만 으로도 충분히 목표를 달성하여 더이상 분석을 진행하진 않았습니다.\n최종 복호화 코드로 채팅 내용만 불러오게 하였습니다.\n1 2 3 4 5 6 7 8 9 10 11 def decode(bytes): test = bytes.split(b'\\x0c') res = [] for i in test: res.append(str(i, 'utf-8')) if(res[1] != '-1' and res[1] != '1' and '|' not in res[1]): if(len(res) \u003e 5): print(res[1], res[2], res[6]) else: # print(res) pass 결과 채팅 받아오기 성공!\n🚨 5분이 지나면 ERROR: no close frame received or sent 메세지와 함께 소켓 연결이 끊어집니다.\n채팅을 자동으로 불러올 수 있을까? (고도화) 아프리카TV 채팅창 내용을 불러오는 것 까지는 성공했습니다 ! 다만, 추첨을 할때마다 네트워크탭을 켜서 필요한 값들을 복사할 수는 없기에 해당 값들까지 분석하여 URL만 제공해도 모든것이 자동으로 돌아가져야 합니다. 필요한 값은 딱 3개 입니다. 위 테스트 코드에서 변수명은 다음과 같습니다. WSSUrl, Base64PdboxTicket, Base64ChannelInfo\n채팅방 웹소켓 URL (WSSUrl) 첫번째 핸드쉐이크 값 (Base64PdboxTicket) 두번째 핸드쉐이크 값 (Base64ChannelInfo) 아직 진행중인 내용으로 고도화 분석은 계속해서 진행중입니다.\n","wordCount":"1456","inLanguage":"en","datePublished":"2023-03-23T00:00:00Z","dateModified":"2023-03-23T00:00:00Z","author":{"@type":"Person","name":"cha2hyun"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://cha2hyun.github.io/posts/youtubeafreecacrawling/"},"publisher":{"@type":"Organization","name":"채수현 개발일지","logo":{"@type":"ImageObject","url":"https://cha2hyun.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div><div class=logo><a href=https://cha2hyun.github.io/ accesskey=h title="채수현 개발일지 (Alt + H)">채수현 개발일지<span style=justify-content:center>
<img src="https://visitor-badge.glitch.me/badge?page_id=cha2hyun.github.io&left_color=black&right_color=black&left_text=HITS" alt=Views></span></a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><div class=logo style=margin-bottom:-30px;margin-top:-30px;font-size:15px><span>기억은 유한하나, 기록은 무한하다 📚</span></div></div><ul id=menu><li><a href=https://cha2hyun.github.io/projects/ title=프로젝트><span style=font-weight:700>프로젝트</span></a></li><li><a href=https://cha2hyun.github.io/algorithm/ title=알고리즘><span style=font-weight:700>알고리즘</span></a></li><li><a href=https://cha2hyun.github.io/posts/ title=블로그><span style=font-weight:700>블로그</span></a></li><li><a href=https://cha2hyun.github.io/search/ title=검색><span style=font-weight:700>검색</span></a></li><li><a href=https://cha2hyun.github.io/tags/ title=태그><span style=font-weight:700>태그</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs></div><a href=https://cha2hyun.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://cha2hyun.github.io/posts/>Posts</a></div><h1 class=post-title>유튜브 라이브, 아프리카TV 실시간 채팅 크롤링 하기 feat.배돌이의 당구생활</h1><div class=post-meta><div class=views style=margin-right:8px><span class=views><img src="https://visitor-badge.glitch.me/badge?page_id=https%3a%2f%2fcha2hyun.github.io%2fposts%2fyoutubeafreecacrawling%2f&left_color=gray&right_color=gray&left_text=Article Hits" alt=Views></span></div><span title='2023-03-23 00:00:00 +0000 UTC'>March 23, 2023</span>&nbsp;·&nbsp;7 min&nbsp;·&nbsp;cha2hyun</div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%eb%93%a4%ec%96%b4%ea%b0%80%eb%a9%b0 aria-label=들어가며>들어가며</a></li><li><a href=#%ec%9c%a0%ed%8a%9c%eb%b8%8c-%eb%9d%bc%ec%9d%b4%eb%b8%8c-%ec%8b%a4%ec%8b%9c%ea%b0%84-%eb%8c%93%ea%b8%80-%ed%81%ac%eb%a1%a4%eb%a7%81 aria-label="유튜브 라이브 실시간 댓글 크롤링">유튜브 라이브 실시간 댓글 크롤링</a><ul><li><a href=#%eb%9d%bc%ec%9d%b4%eb%b8%8c%eb%9f%ac%eb%a6%ac aria-label=라이브러리>라이브러리</a></li><li><a href=#thread aria-label=Thread>Thread</a></li><li><a href=#%ec%bd%94%eb%93%9c aria-label=코드>코드</a></li><li><a href=#%ec%bd%94%eb%93%9c%ec%84%a4%eb%aa%85 aria-label=코드설명>코드설명</a></li><li><a href=#%ec%8b%a4%ed%96%89%ed%8c%8c%ec%9d%bc aria-label=실행파일>실행파일</a></li><li><a href=#%ea%b2%b0%ea%b3%bc aria-label=결과>결과</a></li></ul></li><li><a href=#%ec%95%84%ed%94%84%eb%a6%ac%ec%b9%b4tv-%ec%8b%a4%ec%8b%9c%ea%b0%84-%eb%8c%93%ea%b8%80-%ed%81%ac%eb%a1%a4%eb%a7%81 aria-label="아프리카TV 실시간 댓글 크롤링">아프리카TV 실시간 댓글 크롤링</a><ul><li><a href=#%ec%95%84%ed%94%84%eb%a6%ac%ec%b9%b4tv-%ec%b1%84%ed%8c%85%eb%b0%a9-%eb%b6%84%ec%84%9d-23%eb%85%84-3%ec%9b%94-23%ec%9d%bc-%ea%b8%b0%ec%a4%80 aria-label="아프리카TV 채팅방 분석 (23년 3월 23일 기준)">아프리카TV 채팅방 분석 (23년 3월 23일 기준)</a></li><li><a href=#%ec%b1%84%ed%8c%85%ec%9d%84-%ec%96%b4%eb%96%bb%ea%b2%8c%eb%93%a0-%eb%b6%88%eb%9f%ac%ec%98%ac-%ec%88%98-%ec%9e%88%ec%9d%84%ea%b9%8c-%ed%95%b8%eb%93%9c%ec%89%90%ec%9d%b4%ed%81%ac-%eb%b6%84%ec%84%9d aria-label="채팅을 어떻게든 불러올 수 있을까? (핸드쉐이크 분석)">채팅을 어떻게든 불러올 수 있을까? (핸드쉐이크 분석)</a><ul><li><a href=#%ec%b2%ab%eb%b2%88%ec%a7%b8-%ed%95%b8%eb%93%9c%ec%89%90%ec%9d%b4%ed%81%ac aria-label="첫번째 핸드쉐이크">첫번째 핸드쉐이크</a></li><li><a href=#%eb%91%90%eb%b2%88%ec%a7%b8-%ed%95%b8%eb%93%9c%ec%89%90%ec%9d%b4%ed%81%ac aria-label="두번째 핸드쉐이크">두번째 핸드쉐이크</a></li><li><a href=#test-code aria-label="Test Code">Test Code</a></li><li><a href=#%ea%b2%b0%ea%b3%bc-1 aria-label=결과>결과</a></li></ul></li><li><a href=#%ec%b1%84%ed%8c%85%ec%9d%84-%ec%9e%90%eb%8f%99%ec%9c%bc%eb%a1%9c-%eb%b6%88%eb%9f%ac%ec%98%ac-%ec%88%98-%ec%9e%88%ec%9d%84%ea%b9%8c-%ea%b3%a0%eb%8f%84%ed%99%94 aria-label="채팅을 자동으로 불러올 수 있을까? (고도화)">채팅을 자동으로 불러올 수 있을까? (고도화)</a><ul><li><a href=#%ec%b1%84%ed%8c%85%eb%b0%a9-%ec%9b%b9%ec%86%8c%ec%bc%93-url-wssurl aria-label="채팅방 웹소켓 URL (WSSUrl)">채팅방 웹소켓 URL (WSSUrl)</a></li><li><a href=#%ec%b2%ab%eb%b2%88%ec%a7%b8-%ed%95%b8%eb%93%9c%ec%89%90%ec%9d%b4%ed%81%ac-%ea%b0%92-base64pdboxticket aria-label="첫번째 핸드쉐이크 값 (Base64PdboxTicket)">첫번째 핸드쉐이크 값 (Base64PdboxTicket)</a></li><li><a href=#%eb%91%90%eb%b2%88%ec%a7%b8-%ed%95%b8%eb%93%9c%ec%89%90%ec%9d%b4%ed%81%ac-%ea%b0%92-base64channelinfo aria-label="두번째 핸드쉐이크 값 (Base64ChannelInfo)">두번째 핸드쉐이크 값 (Base64ChannelInfo)</a></li></ul></li></ul></li></ul></div></details></div><div class=post-content><h3 id=들어가며>들어가며<a hidden class=anchor aria-hidden=true href=#들어가며>#</a></h3><p>김치빌리아드, 큐찾사 유튜브채널 <code>배돌이의 당구생활</code>의 컨텐츠 라이브 개인큐 추첨에서 실시간 시청자들의 댓글을 긁어와서 추첨하는게 필요했습니다. (다시봐도 매주 백만원 넘게 뿌리는 진짜 미친 이벤트이긴 합니다.)</p><figure class=align-center><img loading=lazy src=../img/7.png#center alt="배당생 개인큐 추첨 라이브 진짜 100% 진짜.."><figcaption><p>배당생 개인큐 추첨 라이브 진짜 100% 진짜..</p></figcaption></figure><p>이벤트는 매우 매우 간단한 방법으로 채팅에 참여한 사람들을 추출해서 돌림판에 넣고 추첨합니다. 초반에는 유튜브에서 제공하는 채팅방 실시간 참여자를 드래그해서 추첨판에 복붙하였습니다. 저의 부캐 <strong>채PD</strong>로 제가 직접 방송에 참여하면서 컴퓨터를 조작하면 괜찮지만 방송에 참여하지 못하는 날들엔 배돌이가 직접 하기에 어려운 부분이 있어서 클릭 한 번만 하면 자동으로 해주는 <strong>실행파일</strong> 프로그램을 만들기로 했습니다.</p><br><h3 id=유튜브-라이브-실시간-댓글-크롤링>유튜브 라이브 실시간 댓글 크롤링<a hidden class=anchor aria-hidden=true href=#유튜브-라이브-실시간-댓글-크롤링>#</a></h3><p><figure class=align-center><img loading=lazy src=../img/8.png#center alt="결과 미리보기"><figcaption><p>결과 미리보기</p></figcaption></figure>구상한 순서는 다음과 같습니다.</p><ol><li>배돌이가 채팅 참여해주세요 라고 말하고 크롤링 프로그램을 킨다.</li><li>배돌이가 마감합니다 라고 말하고 아무 키를 누르면 크롤링이 끝난다</li><li>채팅에 참여한 모든 사람들을 추출한다.</li><li>셀레늄으로 돌림판 제공하는 사이트를 띄우고</li><li>추출한 사람들을 자동으로 넣고 돌린다.</li></ol><h4 id=라이브러리>라이브러리<a hidden class=anchor aria-hidden=true href=#라이브러리>#</a></h4><p>유튜브 라이브의 경우 서드파티 라이브러리가 많이 있습니다. <code>Don't reinvent the wheel</code>이란 말처럼 (귀차니즘) 라이브러리를 사용하기로 했고 여기서 사용한 라이브러리는 <code>pychat</code> 입니다.</p><h4 id=thread>Thread<a hidden class=anchor aria-hidden=true href=#thread>#</a></h4><p>추첨을 시작하고 추첨을 끝내기 위해선 어떠한 이벤트가 발생해야 하는데 키보드의 아무 키가 입력되면 멈추게끔 프로그램을 작동시켜야합니다. 그러기 위해서는 <code>멀티쓰레드</code>로 키보드 이벤트를 감지하는 쓰레드가 하나 계속 돌고있어야 합니다.</p><h4 id=코드>코드<a hidden class=anchor aria-hidden=true href=#코드>#</a></h4><div class="terminal space shadow"><div class=top><div class=btns><span class="circle red"></span>
<span class="circle yellow"></span>
<span class="circle green"></span></div><div class=title>youtube 크롤링</div></div><div class=terminalbody><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pyperclip</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pytchat</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>threading</span> <span class=k>as</span> <span class=nn>th</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>selenium</span> <span class=kn>import</span> <span class=n>webdriver</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>selenium.webdriver.common.by</span> <span class=kn>import</span> <span class=n>By</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>selenium.webdriver.chrome.service</span> <span class=kn>import</span> <span class=n>Service</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>webdriver_manager.chrome</span> <span class=kn>import</span> <span class=n>ChromeDriverManager</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 키보드 이벤트 감지</span>
</span></span><span class=line><span class=cl><span class=n>CAPTURING</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>stop_capture</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>CAPTURING</span>
</span></span><span class=line><span class=cl>    <span class=nb>input</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>CAPTURING</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>start_capture</span><span class=p>(</span><span class=n>video_id</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># 키보드 이벤트 감지를 쓰레드로 실행</span>
</span></span><span class=line><span class=cl>    <span class=n>th</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>stop_capture</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=p>(),</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;stop_capture&#39;</span><span class=p>,</span> <span class=n>daemon</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>chat</span> <span class=o>=</span> <span class=n>pytchat</span><span class=o>.</span><span class=n>create</span><span class=p>(</span><span class=n>video_id</span><span class=o>=</span><span class=n>video_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>author_name</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=n>start</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s1>&#39;%Y-%m-</span><span class=si>%d</span><span class=s1> %H-%M-%S&#39;</span><span class=p>,</span> <span class=n>time</span><span class=o>.</span><span class=n>localtime</span><span class=p>(</span><span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()))</span>
</span></span><span class=line><span class=cl>    <span class=n>today</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s1>&#39;%Y-%m-</span><span class=si>%d</span><span class=s1>&#39;</span><span class=p>,</span> <span class=n>time</span><span class=o>.</span><span class=n>localtime</span><span class=p>(</span><span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 결과값을 저장할 위치</span>
</span></span><span class=line><span class=cl>    <span class=n>current</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>getcwd</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>path</span> <span class=o>=</span> <span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>current</span><span class=si>}</span><span class=s1>/</span><span class=si>{</span><span class=n>today</span><span class=si>}</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>exists</span><span class=p>(</span><span class=n>path</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>os</span><span class=o>.</span><span class=n>makedirs</span><span class=p>(</span><span class=n>path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>OSError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Error: Cannot create the directory </span><span class=si>{}</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>path</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>fp</span> <span class=o>=</span> <span class=nb>open</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>path</span><span class=si>}</span><span class=s1>/</span><span class=si>{</span><span class=n>start</span><span class=si>}</span><span class=s1>.txt&#39;</span><span class=p>,</span> <span class=s1>&#39;w&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>cnt</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 크롤링 시작</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=n>CAPTURING</span> <span class=ow>and</span> <span class=n>chat</span><span class=o>.</span><span class=n>is_alive</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>c</span> <span class=ow>in</span> <span class=n>chat</span><span class=o>.</span><span class=n>get</span><span class=p>()</span><span class=o>.</span><span class=n>sync_items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>c</span><span class=o>.</span><span class=n>author</span><span class=o>.</span><span class=n>name</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>author_name</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>author_name</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>c</span><span class=o>.</span><span class=n>author</span><span class=o>.</span><span class=n>name</span><span class=si>}</span><span class=s1> | @</span><span class=si>{</span><span class=n>c</span><span class=o>.</span><span class=n>author</span><span class=o>.</span><span class=n>channelId</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[</span><span class=si>{</span><span class=n>c</span><span class=o>.</span><span class=n>datetime</span><span class=p>[</span><span class=mi>11</span><span class=p>:]</span><span class=si>}</span><span class=s2>] 아이디: </span><span class=si>{</span><span class=n>c</span><span class=o>.</span><span class=n>author</span><span class=o>.</span><span class=n>name</span><span class=si>}</span><span class=s2> | @</span><span class=si>{</span><span class=n>c</span><span class=o>.</span><span class=n>author</span><span class=o>.</span><span class=n>channelId</span><span class=si>}</span><span class=se>\n\t</span><span class=s2>   내용: </span><span class=si>{</span><span class=n>c</span><span class=o>.</span><span class=n>message</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>fp</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[</span><span class=si>{</span><span class=n>c</span><span class=o>.</span><span class=n>datetime</span><span class=p>[</span><span class=mi>11</span><span class=p>:]</span><span class=si>}</span><span class=s2>] 아이디: </span><span class=si>{</span><span class=n>c</span><span class=o>.</span><span class=n>author</span><span class=o>.</span><span class=n>name</span><span class=si>}</span><span class=s2> | @</span><span class=si>{</span><span class=n>c</span><span class=o>.</span><span class=n>author</span><span class=o>.</span><span class=n>channelId</span><span class=si>}</span><span class=se>\n\t</span><span class=s2>   내용: </span><span class=si>{</span><span class=n>c</span><span class=o>.</span><span class=n>message</span><span class=si>}</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>cnt</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>KeyboardInterrupt</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>chat</span><span class=o>.</span><span class=n>terminate</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>end</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s1>&#39;%Y-%m-</span><span class=si>%d</span><span class=s1> %H:%M:%S&#39;</span><span class=p>,</span> <span class=n>time</span><span class=o>.</span><span class=n>localtime</span><span class=p>(</span><span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()))</span>
</span></span><span class=line><span class=cl>    <span class=n>author_name</span><span class=o>.</span><span class=n>sort</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>author_name</span> <span class=o>=</span> <span class=p>(</span><span class=nb>list</span><span class=p>(</span><span class=nb>set</span><span class=p>(</span><span class=n>author_name</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>====================================================================&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;배돌이의당구생활 라이브 추첨 댓글 추출</span><span class=se>\n</span><span class=s2>시작 </span><span class=si>{</span><span class=n>start</span><span class=si>}</span><span class=s2> | 종료 </span><span class=si>{</span><span class=n>end</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;채팅에 참여한 사람 </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=nb>list</span><span class=p>(</span><span class=nb>set</span><span class=p>(</span><span class=n>author_name</span><span class=p>)))</span><span class=si>}</span><span class=s2>명 (중복제거) | 총 채팅수 : </span><span class=si>{</span><span class=nb>format</span><span class=p>(</span><span class=n>cnt</span><span class=p>,</span> <span class=s1>&#39;,&#39;</span><span class=p>)</span><span class=si>}</span><span class=s2>개&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>author_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;====================================================================</span><span class=se>\n\n</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;추출을 종료합니다.&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>fp</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>====================================================================</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>fp</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;배돌이의당구생활 라이브 추첨 댓글 추출</span><span class=se>\n</span><span class=s2>시작 </span><span class=si>{</span><span class=n>start</span><span class=si>}</span><span class=s2> | 종료 </span><span class=si>{</span><span class=n>end</span><span class=si>}</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>fp</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;채팅에 참여한 사람 </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=nb>list</span><span class=p>(</span><span class=nb>set</span><span class=p>(</span><span class=n>author_name</span><span class=p>)))</span><span class=si>}</span><span class=s2>명 (중복제거) | 총 채팅수 : </span><span class=si>{</span><span class=n>cnt</span><span class=si>}</span><span class=s2>개</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>fp</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>author_name</span><span class=si>}</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>fp</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=s1>&#39;====================================================================</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>fp</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>picker</span><span class=p>(</span><span class=n>author_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>author_name</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>list_chuck</span><span class=p>(</span><span class=n>arr</span><span class=p>,</span> <span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>[</span><span class=n>arr</span><span class=p>[</span><span class=n>i</span><span class=p>:</span> <span class=n>i</span> <span class=o>+</span> <span class=n>n</span><span class=p>]</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>arr</span><span class=p>),</span> <span class=n>n</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>picker</span><span class=p>(</span><span class=n>author_name</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>driver</span> <span class=o>=</span> <span class=n>webdriver</span><span class=o>.</span><span class=n>Chrome</span><span class=p>(</span><span class=n>service</span><span class=o>=</span><span class=n>Service</span><span class=p>(</span><span class=n>ChromeDriverManager</span><span class=p>()</span><span class=o>.</span><span class=n>install</span><span class=p>()))</span>
</span></span><span class=line><span class=cl>        <span class=n>url</span> <span class=o>=</span> <span class=s1>&#39;https://spinnerwheel.ahaslides.com/?entries=&amp;action=true&#39;</span>
</span></span><span class=line><span class=cl>        <span class=n>driver</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>url</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>driver</span><span class=o>.</span><span class=n>implicitly_wait</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>input_box</span> <span class=o>=</span> <span class=n>driver</span><span class=o>.</span><span class=n>find_element</span><span class=p>(</span><span class=n>By</span><span class=o>.</span><span class=n>XPATH</span><span class=p>,</span> <span class=s1>&#39;//*[@id=&#34;aha-spinner-wheel&#34;]/div[2]/div/div[3]/div[2]/form/div/div/input&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>add_button</span> <span class=o>=</span> <span class=n>driver</span><span class=o>.</span><span class=n>find_element</span><span class=p>(</span><span class=n>By</span><span class=o>.</span><span class=n>XPATH</span><span class=p>,</span> <span class=s1>&#39;//*[@id=&#34;aha-spinner-wheel&#34;]/div[2]/div/div[3]/div[2]/form/button&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=n>list_chuck</span><span class=p>(</span><span class=n>author_name</span><span class=p>,</span> <span class=mi>30</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>r</span> <span class=ow>in</span> <span class=n>result</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>text</span> <span class=o>=</span> <span class=s1>&#39;,&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>r</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>JS_ADD_TEXT_TO_INPUT</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>            var elm = arguments[0], txt = arguments[1];
</span></span></span><span class=line><span class=cl><span class=s2>            elm.value += txt;
</span></span></span><span class=line><span class=cl><span class=s2>            elm.dispatchEvent(new Event(&#39;change&#39;));
</span></span></span><span class=line><span class=cl><span class=s2>            &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>            <span class=n>driver</span><span class=o>.</span><span class=n>execute_script</span><span class=p>(</span><span class=n>JS_ADD_TEXT_TO_INPUT</span><span class=p>,</span> <span class=n>input_box</span><span class=p>,</span> <span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>input_box</span><span class=o>.</span><span class=n>send_keys</span><span class=p>(</span><span class=s1>&#39; &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>add_button</span><span class=o>.</span><span class=n>click</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span><span class=p>(</span><span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>pass</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>========================================&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;배돌이의당구생활 라이브 추첨 댓글 추출&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>video_id</span> <span class=o>=</span> <span class=nb>input</span><span class=p>(</span><span class=s2>&#34;영상 URL을 입력해주세요 : &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;확인되었습니다. 댓글 추출을 시작합니다.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s1>&#39;========================================&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>author_name</span> <span class=o>=</span> <span class=n>start_capture</span><span class=p>(</span><span class=n>video_id</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></div></div><br><h4 id=코드설명>코드설명<a hidden class=anchor aria-hidden=true href=#코드설명>#</a></h4><p>pychat 라이브러리를 사용하기 떄문에 코드가 매우 간단합니다. <code>start_capture</code>로 캡쳐가 시작되고 함께 <code>th.Thread(target=stop_capture, args=(), name='stop_capture', daemon=True).start()</code>로 <code>stop_capture</code> 함수를 쓰레드로 시작합니다.</p><p><code>stop_capture</code>에서 <code>input()</code>을 기다리고 있는데 이는 실행중에 키보드값이 입력되면 <code>global</code>로 선언된 <code>CAPTURING</code> 변수를 <code>false</code>로 변경하여 크롤링을 멈추게 됩니다. 쓰레드를 활용하는 환경에서 전체적으로 참조해야할 변수를 선언하려면 꼭 <code>global</code>을 사용해야합니다.</p><p>키보드 이벤트가 감지되어 추출이 멈추게되면 <code>picker</code> 함수를 실행시킵니다. 해당 함수는 <code>selenium</code>을 이용하여 결과값을 돌림판에 입력하는것 까지 자동으로 진행되게 합니다. 닉네임 중복이 가능하므로 유저의 고유번호까지 추출되어야하며 나중에 비교하기 위해서 텍스트 파일로 결과를 저장합니다. 추출 결과값을 브라우저의 인풋에 넣고 확인을 눌러줘야 하는데 이때 어쩔 수 없이 자바스크립트 문법이 필요하였습니다.<br></p><h4 id=실행파일>실행파일<a hidden class=anchor aria-hidden=true href=#실행파일>#</a></h4><p><code>실행파일</code>로 만들고 어떠한 환경에서도 실행되어야 해서 기존의 <strong>웹드라이버</strong>를 수동으로 다운받아서 옮기지 않고 자동으로 다운로드 받아야하여 다음 명령어로 웹드라이버를 로드하였습니다. <code>webdriver.Chrome(service=Service(ChromeDriverManager().install()))</code></p><p>실행파일로 만들어주기 위해 <code>pyinstaller</code> 라이브러리를 사용했습니다. 이렇게 하면 최신 드라이버를 받아주고 실행파일 용량압박에도 살아남을 수 있게됩니다.</p><figure class=align-center><img loading=lazy src=../img/9.png#center alt="이미지도 깜찍하게"><figcaption><p>이미지도 깜찍하게</p></figcaption></figure><h4 id=결과>결과<a hidden class=anchor aria-hidden=true href=#결과>#</a></h4><p>실제로 어떻게 작동되는지 궁금하시면 <a href="https://www.youtube.com/live/WbriWhcdozk?feature=share" target=_blank>다음 링크나</a> 아래 영상을 확인해주세요. 도움이 되셨다면 구독과.. 좋..아&mldr;요&mldr;</p><center><iframe width=800 height=420 src="https://www.youtube.com/embed/egb1Vl5A__k?start=1670" title="YouTube video player" frameborder=0 allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe></center><hr><br><h3 id=아프리카tv-실시간-댓글-크롤링>아프리카TV 실시간 댓글 크롤링<a hidden class=anchor aria-hidden=true href=#아프리카tv-실시간-댓글-크롤링>#</a></h3><p>방송프로그램으로 OBS를 사용하고 있는데, 최근 M1맥 업데이트로 <strong>동시송출 플러그인</strong> 사용이 가능해졌습니다. 유트브에서 유튜브 + 아프리카TV로 넘어가는 계획중인데 추첨방송을 계속 이어서 진행하기 위해 유튜브, 아프리카tv 두개 채팅을 실시간으로 크롤링하려 합니다.</p><p>아프리카TV의 경우 참고할만한 레퍼런스가 매우 매우 매우 매우 매우 없어서 정말&mldr; 맨땅에 해딩했는데 성공했다는 뿌듯함에 상세히 과정을 함께 보여드리려 합니다. (아직 현재진행중)</p><h4 id=아프리카tv-채팅방-분석-23년-3월-23일-기준>아프리카TV 채팅방 분석 (23년 3월 23일 기준)<a hidden class=anchor aria-hidden=true href=#아프리카tv-채팅방-분석-23년-3월-23일-기준>#</a></h4><figure class=align-center><img loading=lazy src=../img/1.gif#center alt="탭이동 하면 소켓연결이 끊어지고 다시 돌아오면 새로 연결된다"><figcaption><p>탭이동 하면 소켓연결이 끊어지고 다시 돌아오면 새로 연결된다</p></figcaption></figure><p>크롬의 개발자도구 네트워크탭을 분석해보면 아프리카TV의 채팅방의 경우 대략적으로 다음과 같이 웹소켓 서버와 연결됨을 알 수 있습니다.</p><ol><li><p>사람이 동영상을 보고있는지 계속 확인하는 웹소켓 1개<figure class=align-center><img loading=lazy src=../img/10.png#center alt="일정시간마다 핸드쉐이크를 꼐속 진행한다"><figcaption><p>일정시간마다 핸드쉐이크를 꼐속 진행한다</p></figcaption></figure></p></li><li><p>사람이 동영상을 보고있다고 판단되면 채팅방 연결하는 웹소켓 1개<figure class=align-center><img loading=lazy src=../img/11.png#center alt="맨 처음에만 핸드쉐이크"><figcaption><p>맨 처음에만 핸드쉐이크</p></figcaption></figure></p></li></ol><p>사람이 동영상을 안보고있다고 판단되면 모든 소켓 연결을 끊어버립니다. 소리는 들려도 채팅은 보여지지 않습니다. 다시 동영상에 입장하면 당연히 처음부터 소켓연결을 재시작하기 떄문에 이전 채팅 내용들이 사라지게 됩니다 <em>입장, 퇴장 여부도 전부 소켓에 찍힙니다.</em></p><p>우선 가장 중요한 부분은 실제 채팅이 오고 가는 것이 찍히는 위 <strong>2번 웹소켓</strong>입니다. 해당 웹소켓에 연결하기 위해서는 ⭐️<strong>다음 값들을</strong>⭐️ 알아야합니다.</p><ol><li>웹소켓 주소<blockquote><p>채팅방 입장시 받아오는 <strong>API</strong> 혹은 <strong>1번 웹소켓</strong>에서 불러와질 수 있습니다.</p></blockquote></li><li>핸드쉐이크때 필요한 값<blockquote><p>위의 웹소켓 주소를 받아올때 같이 넘겨받는 값이 특정 <code>bytes array</code> 구조로 보내져야합니다.</p></blockquote></li></ol><p>우선은 1번 2번은 재껴두고 소켓에 연결해서 채팅을 넘겨받을 수 있는지 확인해보겠습니다.</p><h4 id=채팅을-어떻게든-불러올-수-있을까-핸드쉐이크-분석>채팅을 어떻게든 불러올 수 있을까? (핸드쉐이크 분석)<a hidden class=anchor aria-hidden=true href=#채팅을-어떻게든-불러올-수-있을까-핸드쉐이크-분석>#</a></h4><p>총 2번의 핸드쉐이크 혹은 정보를 전달하는 것을 알 수 있습니다. 각각의 핸드쉐이크때 어떠한 정보를 보내야 연결이 성공되어 나머지 정보도 전달받는지 분석이 필요합니다.<figure class=align-center><img loading=lazy src=../img/12.png#center></figure></p><h5 id=첫번째-핸드쉐이크>첫번째 핸드쉐이크<a hidden class=anchor aria-hidden=true href=#첫번째-핸드쉐이크>#</a></h5><p>첫번째 핸드쉐이크의 값중 유의미한 값은 <code>A32.</code>로 시작합니다. 네트워크탭을 분석해본 결과 아프리카TV API로 요청을 보낼때 쿠키로 함께 보내지는 <code>PdboxTicket</code> 값임을 확인했습니다. 추가로 많은 테스트 결과 해당값은 <strong>절대 변하지 않는</strong> 값으로 한번만 확인하면 계속 사용할 수 있는 값입니다.</p><p><figure class=align-center><img loading=lazy src=../img/13.png#center></figure><figure class=align-center><img loading=lazy src=../img/14.png#center></figure></p><h5 id=두번째-핸드쉐이크>두번째 핸드쉐이크<a hidden class=anchor aria-hidden=true href=#두번째-핸드쉐이크>#</a></h5><p>두번째 핸드쉐이크는 <code>_</code> 로 나누어지거나 <code>&</code>으로 값이 나누어 져있었습니다. <code>&</code>으로 나누어진 것을 보면 뭔가 파라미터 값을 전송하는 것으로 예측 할 수 있습니다. 전달되는 값들은 API의 리스폰스나 JS파일을 분석하면 나옵니다. 우선은 파이썬으로 핸드쉐이크떄 보내지는 값을 <strong>그대로</strong> 전송했을때 연결이 되는지 확인해봅니다<figure class=align-center><img loading=lazy src=../img/15.png#center></figure></p><h5 id=test-code>Test Code<a hidden class=anchor aria-hidden=true href=#test-code>#</a></h5><p><figure class=align-center><img loading=lazy src=../img/16.png#center></figure>해당값을 <code>UTF-8</code>즉 string 형태로 그대로 복사할 경우 깨져서 보여지지 않기 떄문에 base64 값으로 복사한다음에 코드에서 복호화 하는 형태로 진행합니다.</p><p><div class="terminal space shadow"><div class=top><div class=btns><span class="circle red"></span>
<span class="circle yellow"></span>
<span class="circle green"></span></div><div class=title>핸드쉐이크 테스트</div></div><div class=terminalbody><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>certifi</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>ssl</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>base64</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>asyncio</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>websockets</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># WSS 연결 위한 SSL 설정</span>
</span></span><span class=line><span class=cl><span class=n>ssl_context</span> <span class=o>=</span> <span class=n>ssl</span><span class=o>.</span><span class=n>create_default_context</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>ssl_context</span><span class=o>.</span><span class=n>load_verify_locations</span><span class=p>(</span><span class=n>certifi</span><span class=o>.</span><span class=n>where</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=n>ssl_context</span><span class=o>.</span><span class=n>check_hostname</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl><span class=n>ssl_context</span><span class=o>.</span><span class=n>verify_mode</span> <span class=o>=</span> <span class=n>ssl</span><span class=o>.</span><span class=n>CERT_NONE</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 아래 3개 변수값은 어딘가의 API로 부터 받은 값들의 조합으로 우선은 그대로 사용</span>
</span></span><span class=line><span class=cl><span class=n>Base64PdboxTicket</span> <span class=o>=</span> <span class=s1>&#39;GwkwMDAxMDAwNTg3MDAMLkEzMi43YmJUNTZ2eUhNOWZLWmsuQ1V0N0dxNXdzSW95ZGdUejRvT0JkUGJEVTRPTEJjbDNEUkFUenJUYkhrQzlYRmtiZnl1YXMwUzE3SFlyZDFjbFU1VzV4U3hpTUJYS2lmV25fVXFDQThWWUYxczVidE04QzJuenhWN3NEVzlTcHFPM2V4VHNHQUMxU3ZmNTlCNUE1bDVrUFJsZHpleHB4OGxKbkJFYXE5UXNLbW1KQ21TTExQRm1JNkc3Q0FHZ1R0UDFWcGhzaTYzTDZXUHRDdkRPalZDNTg1LXVJQV9hRGRxcTlWX1pOWUlBQ0N3d3Yxb0NDckRLeE9icldKS0xpQlNrbGs3bW1TMkkwWVdtNnhiMDB2TG53OGJuQXVyZzRyNkpHeWVma0ZDWmZaM0V6c29LTEFwRU9xeFlkX0JXMVNxRWVNM1FuNkoyc0E5Y0d5WGFZLWhySm5wblJGNmN4RzFPTWJBSi1KVGVXc2JTLTNaNUNULS1fUW1vTWJCb2stSmJwUmt1Y1oxMURJSkFpY25NZmwxaWtzU1Y4aHh6YUVqWVExb19pamI1OXVCWUNYMlNsMFdLSEwydjk4WkhSLXZGNjNRRDY5VEtqSEpjaHBIaDh0RFNzUUxJekc3WUFZbmpKYjl3cDlvV2JfVi0wSFgyRFRYVnVUSEtKRTFPMWNtbHE1bC1qaXZ6bW1HdnJ0WnVmQVVfRG1NQzA1bUpPelNxZTl0bzNKVFZmMjBJWldfWXFpW...==&#39;</span>
</span></span><span class=line><span class=cl><span class=n>Base64ChannelInfo</span> <span class=o>=</span> <span class=s1>&#39;GwkwMDAyMDAwMjk3MDAMOTYxOAw0NTY1MzFjMDg0YjUxMGJkOTAyYWViZDcyMjFiMjUyNl92bGZ2bGY3ODlfMjQ1NTkwMzY1X2lvcwwwDAxsb2cRBiYGc2V0X2JwcwY9BjgwMDAGJgZ2aWV3X2JwcwY9BjEwMDAGJgZxdWFsaXR5Bj0Gbm9ybWFsBiYGdXVpZAY9BjFlNDNjZjZkMzc5MTNjMzZiMzVkNTgwZTBiNTY1NmVjBiYGZ2VvX2NjBj0GS1IGJgZnZW9fcmMGPQYxMQYmBmFjcHRfbGFuZwY9BmtvX0tSBiYGc3ZjX2xhbmcGPQZrb19LUgYmBmpvaW5fY2MGPQY0MTAScHdkERJhdXRoX2luZm8RTlVMTBJwdmVyETESYWNjZXNzX3N5c3R...=&#39;</span>
</span></span><span class=line><span class=cl><span class=n>WSSUrl</span> <span class=o>=</span> <span class=s1>&#39;wss://chat-76dbfccf.afreecatv.com:8001/Websocket/vlfvlf789&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>connect</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=c1># 웹 소켓에 접속을 합니다.</span>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>with</span> <span class=n>websockets</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span><span class=n>WSSUrl</span><span class=p>,</span> <span class=n>subprotocols</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;chat&#39;</span><span class=p>],</span> <span class=n>ssl</span><span class=o>=</span><span class=n>ssl_context</span><span class=p>,</span> <span class=n>ping_interval</span><span class=o>=</span><span class=kc>None</span><span class=p>)</span> <span class=k>as</span> <span class=n>websocket</span><span class=p>:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 핸드쉐이크</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=n>websocket</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>base64</span><span class=o>.</span><span class=n>b64decode</span><span class=p>(</span><span class=n>Base64PdboxTicket</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=n>websocket</span><span class=o>.</span><span class=n>recv</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=n>websocket</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>base64</span><span class=o>.</span><span class=n>b64decode</span><span class=p>(</span><span class=n>Base64ChannelInfo</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 이후부터 채팅내용 받아와짐</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>data</span> <span class=o>=</span> <span class=k>await</span> <span class=n>websocket</span><span class=o>.</span><span class=n>recv</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;ERROR:&#34;</span><span class=p>,</span> <span class=n>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>asyncio</span><span class=o>.</span><span class=n>get_event_loop</span><span class=p>()</span><span class=o>.</span><span class=n>run_until_complete</span><span class=p>(</span><span class=n>connect</span><span class=p>())</span>
</span></span></code></pre></td></tr></table></div></div></div></div><br>코드 실행시 데이터를 성공적으로 잘 받아오는 것을 확인 할 수 있었습니다.</p><figure class=align-center><img loading=lazy src=../img/17.png#center></figure><p>단, 바이트 코드로 되어있으면서 hex 값이랑 평문이랑 섞여있기 때문에 해당 데이터를 복호화 해줍니다. <code>\x0c</code> 값이 계속 보이는 것으로 보아 해당 값으로 split 해주고 utf-8로 변환하였습니다.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>decode</span><span class=p>(</span><span class=nb>bytes</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>test</span> <span class=o>=</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x0c</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>res</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>test</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>res</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=s1>&#39;utf-8&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>res</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>해당 코드로 복호화 하였을 경우에 유의미한 값이 보여지는 것을 확인했습니다.<figure class=align-center><img loading=lazy src=../img/18.png#center></figure></p><p><code>res[1]</code> 값에 따라서 배열의 크기가 변경되는 것을 보아 해당 값을 기준으로 어떤 데이터인지 유추해볼 수 있습니다. 여러번 테스트해본 결과 다음과 같습니다.</p><ul><li><code>res[1] = 1</code> 일때 <code>res[2]=id</code> <code>res[3]=닉네임</code>가 채팅방에 <strong>입장</strong> 하였음</li><li><code>res[1] = -1</code> 일때 <code>res[2]=id</code> <code>res[3]=닉네임</code>가 채팅방에 <strong>퇴장</strong> 하였음</li><li><code>res[1] = '문자열'</code> 일때 <code>res[1]=닉네임</code> <code>res[2]=id</code> <code>res[6]=채팅내용</code> 보여지는 채팅입니다.</li></ul><p>다른 경우에는 <code>매니저</code> 이거나 <code>팬</code> 일때 아이디가 색상으로 표시되는 경우 등이 있었지만 위 3가지만 으로도 충분히 목표를 달성하여 더이상 분석을 진행하진 않았습니다.</p><p>최종 복호화 코드로 채팅 내용만 불러오게 하였습니다.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>decode</span><span class=p>(</span><span class=nb>bytes</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>test</span> <span class=o>=</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x0c</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>res</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>test</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>res</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=s1>&#39;utf-8&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=n>res</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>!=</span> <span class=s1>&#39;-1&#39;</span> <span class=ow>and</span> <span class=n>res</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>!=</span> <span class=s1>&#39;1&#39;</span> <span class=ow>and</span> <span class=s1>&#39;|&#39;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>res</span><span class=p>[</span><span class=mi>1</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>res</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>5</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=n>res</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>res</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=n>res</span><span class=p>[</span><span class=mi>6</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># print(res)</span>
</span></span><span class=line><span class=cl>            <span class=k>pass</span>
</span></span></code></pre></td></tr></table></div></div><h5 id=결과-1>결과<a hidden class=anchor aria-hidden=true href=#결과-1>#</a></h5><figure class=align-center><img loading=lazy src=../img/2.gif#center alt="채팅 받아오기 성공!"><figcaption><p>채팅 받아오기 성공!</p></figcaption></figure><p>🚨 5분이 지나면 <code>ERROR: no close frame received or sent</code> 메세지와 함께 소켓 연결이 끊어집니다.</p><h4 id=채팅을-자동으로-불러올-수-있을까-고도화>채팅을 자동으로 불러올 수 있을까? (고도화)<a hidden class=anchor aria-hidden=true href=#채팅을-자동으로-불러올-수-있을까-고도화>#</a></h4><p>아프리카TV 채팅창 내용을 불러오는 것 까지는 성공했습니다 ! 다만, 추첨을 할때마다 네트워크탭을 켜서 필요한 값들을 복사할 수는 없기에 해당 값들까지 분석하여 <strong>URL만 제공해도 모든것이 자동</strong>으로 돌아가져야 합니다. 필요한 값은 <strong>딱 3개</strong> 입니다. 위 테스트 코드에서 변수명은 다음과 같습니다.
<code>WSSUrl, Base64PdboxTicket, Base64ChannelInfo</code></p><h5 id=채팅방-웹소켓-url-wssurl>채팅방 웹소켓 URL (WSSUrl)<a hidden class=anchor aria-hidden=true href=#채팅방-웹소켓-url-wssurl>#</a></h5><h5 id=첫번째-핸드쉐이크-값-base64pdboxticket>첫번째 핸드쉐이크 값 (Base64PdboxTicket)<a hidden class=anchor aria-hidden=true href=#첫번째-핸드쉐이크-값-base64pdboxticket>#</a></h5><h5 id=두번째-핸드쉐이크-값-base64channelinfo>두번째 핸드쉐이크 값 (Base64ChannelInfo)<a hidden class=anchor aria-hidden=true href=#두번째-핸드쉐이크-값-base64channelinfo>#</a></h5><p>아직 진행중인 내용으로 고도화 분석은 계속해서 진행중입니다.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://cha2hyun.github.io/tags/python/>python</a></li><li><a href=https://cha2hyun.github.io/tags/websockets/>websockets</a></li><li><a href=https://cha2hyun.github.io/tags/bs4/>bs4</a></li><li><a href=https://cha2hyun.github.io/tags/selenium/>selenium</a></li><li><a href=https://cha2hyun.github.io/tags/crawling/>crawling</a></li></ul><div style=padding-top:15px;padding-bottom:2px;font-size:x-large;font-weight:700>Any Comments? 😀</div><div class=share-buttons></div><script src=https://utteranc.es/client.js repo=cha2hyun/blog-comments issue-term=title theme=boxy-light crossorigin=anonymous async></script></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://cha2hyun.github.io/>채수현 개발일지</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>